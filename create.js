var l=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var k=(s,r)=>{for(var e in r)l(s,e,{get:r[e],enumerable:!0})},b=(s,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of g(r))!O.call(s,n)&&n!==e&&l(s,n,{get:()=>r[n],enumerable:!(t=m(r,n))||t.enumerable});return s};var _=s=>b(l({},"__esModule",{value:!0}),s);var P={};k(P,{createRepository:()=>v});module.exports=_(P);var a="__PROVIDER_ID__",c=class extends Function{constructor(){super();let r;return r=(...e)=>r._call(...e),Object.setPrototypeOf(r,new.target.prototype)}},u=class extends c{constructor(e,t,n){super();this._call=e;this.initObject=t;this.methods=n;this.muppet=new Proxy({},{get(e,t){return e[a]&&typeof e[a]=="string"&&t!==e[a]&&(e[e[a]]?e[e[a]]={...e[e[a]],select:{...e[e[a]].select||{},[t]:e.init[t]||void 0}}:e[e[a]]={select:{[t]:e.init[t]||void 0}}),e[t]?e[t]:e.init[t]}});this.muppet.init=t;for(let i in t)this[i]=t[i]}};var d=class extends c{constructor(e,t){super();this._watcherFactory=e;this._provider=t;this.keys=[];this.provider=t,this.actions=this.initRepository()}_call(e,t,n){let i,p,o=null;return t&&(p=(t.constructor.name==="Object"?Object.keys(t):Object.getOwnPropertyNames(Object.getPrototypeOf(t))).reduce((w,T)=>T!=="constructor"&&typeof t[T]=="function"?{...w,[T]:t[T].bind(t)}:w,{})),t?t.repo?(t.repo.initializeState(e),t.repo.initializeState(e,p)):(t.repo=this,t.repo.initializeState(e),t.repo.initializeState(e,p)):o=this.initRepository(e,p),n&&(i=new BroadcastChannel(`repository-${n}`),i.onmessage=({data:y})=>{y==="needSome"?i.postMessage({data:(o||t.repo.actions).convertToObject()}):y.type===void 0?this.initRepository(y.data):(o||t.repo.actions).set(y.type,y.data)},i.postMessage("needSome")),(o||t.repo.actions).sourceObj}initializeState(e,t){this.actions=this.initRepository(e,t)}initRepository(e,t){this.keys=Object.keys(e||{});let n=this.keys.reduce((i,p)=>{let o;return this.actions!==void 0&&this.actions.get(p)!==void 0?o=this.actions.get(p):o=e[p],{...i,[p]:[o]}},e||{});return this._watcherFactory(n,this.provider,t)}convertToObject(){return this.keys.reduce((e,t)=>({...e,[t]:this.actions.get(t)}),{})}};var h=class{constructor(){this.SPECIAL_KEY=a}init(r,e,t){typeof r=="object"&&(this.sourceObj=new Proxy(new u(e,Object.keys(r).reduce((n,i)=>({...n,[i]:r[i][0]}),{}),t),{set(n,i,p){n[i]=p,n.muppet.init[i]=p;for(let o in n.muppet)n.muppet[o].__notify__&&n.muppet[o].select.hasOwnProperty(i)&&(n.muppet[o].select={...n.muppet[o].select,[i]:p},n.muppet[o].__notify__());return Array.isArray(n.onUpdate)&&i!=="onUpdate"&&(n.onUpdate.forEach(o=>o()),n.onUpdate=[]),!0}}))}set(r,e){this.sourceObj&&r!=="name"&&r!=="length"&&(this.sourceObj[r]=e)}get(r){if(this.sourceObj&&r)return this.sourceObj[r]}watch(r){return new Promise(e=>{this.sourceObj.onUpdate=[...this.sourceObj.onUpdate,()=>{this.sourceObj[r]&&e(this.sourceObj[r])}]})}watchFor(r,e){return new Promise(t=>{this.sourceObj[r]===e&&t(this.sourceObj[r]),this.sourceObj.onUpdate=[...this.sourceObj.onUpdate,()=>{this.sourceObj[r]===e&&t(this.sourceObj[r])}]})}},f=(s,r,e)=>{let t=new h;return t.init(s,r,e),t};var v=s=>new d(f,s);
