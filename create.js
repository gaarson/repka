var u=Object.defineProperty,O=Object.defineProperties,v=Object.getOwnPropertyDescriptor,C=Object.getOwnPropertyDescriptors,I=Object.getOwnPropertyNames,b=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var _=(s,e,t)=>e in s?u(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,c=(s,e)=>{for(var t in e||(e={}))k.call(e,t)&&_(s,t,e[t]);if(b)for(var t of b(e))M.call(e,t)&&_(s,t,e[t]);return s},y=(s,e)=>O(s,C(e));var x=(s,e)=>{for(var t in e)u(s,t,{get:e[t],enumerable:!0})},P=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of I(e))!k.call(s,r)&&r!==t&&u(s,r,{get:()=>e[r],enumerable:!(n=v(e,r))||n.enumerable});return s};var R=s=>P(u({},"__esModule",{value:!0}),s);var S={};x(S,{createRepository:()=>j});module.exports=R(S);var p="__PROVIDER_ID__",l=class extends Function{constructor(){super();let e;return e=(...t)=>e.__call(...t),Object.setPrototypeOf(e,new.target.prototype)}},g=class extends l{constructor(t,n,r,i){super();this.__call=t;this.__methods=r;this.__onUpdate=[];this.__listeners={};this.call=void 0;for(let a in n)this[a]=n[a];this.muppet=new Proxy({},{get:i.bind(this)})}},w=(s,e,t)=>{function n(r,i){return r[p]&&typeof r[p]=="string"&&i!==r[p]&&(r[r[p]]?r[r[p]]=y(c({},r[r[p]]),{[i]:this[i]!==void 0?this[i]:void 0}):r[r[p]]={[i]:this[i]!==void 0?this[i]:void 0}),r[i]?r[i]:this[i]}return new Proxy(new g(e,s,t,n),{set(r,i,a){if(r[i]=a,r.__listeners[i]&&r.__listeners[i].size)for(let[o,d]of r.__listeners[i])r.muppet[o]&&(r.muppet[o]=y(c({},r.muppet[o]),{[i]:a})),d();return Array.isArray(r.__onUpdate)&&i!=="onUpdate"&&(r.__onUpdate.forEach(o=>o()),r.__onUpdate=[]),!0}})};var h=class extends l{constructor(t,n){super();this._watcherFactory=t;this._provider=n;this.keys=[];this.provider=n,this.actions=this.initRepository()}__call(t,n,r){let i,a=null;return n?(i=(n.constructor.name==="Object"?Object.keys(n):Object.getOwnPropertyNames(Object.getPrototypeOf(n))).reduce((d,T)=>T!=="constructor"&&typeof n[T]=="function"?y(c({},d),{[T]:n[T].bind(n)}):d,{}),n.repo||(n.repo=this),n.repo.initializeState(t,i,r)):a=this.initRepository(t,i,r),(a||n.repo.actions).sourceObj}initializeState(t,n,r){this.actions=this.initRepository(t,n,r)}initRepository(t,n,r){this.keys=Object.keys(t||{});let i=this.keys.reduce((a,o)=>{let d;return this.actions!==void 0&&this.actions.get(o)!==void 0?d=this.actions.get(o):d=t[o],y(c({},a),{[o]:d})},t||{});return this._watcherFactory(i,this.provider,n,r)}};var f=class{constructor(){this.keys=[];this.SPECIAL_KEY=p}init(e,t={}){typeof e=="object"&&!Array.isArray(e)&&(this.keys=Object.keys(e||{}),this.sourceObj=w(e,t.provider,t.methods)),t.broadcastName&&this.createBroadcast(t.broadcastName)}createBroadcast(e="broadcastWatcher"){this.broadcast=new BroadcastChannel(e),this.broadcast.onmessage=({data:t})=>{if(t==="needSome")this.broadcast.postMessage({data:this.get()});else if(t.type===void 0)for(let n in t.data)this.sourceObj[n]=t.data[n];else this.set(t.type,t.data,!0)},this.broadcast.postMessage("needSome")}set(e,t,n=!1){this.sourceObj&&e!=="name"&&e!=="length"&&(this.sourceObj[e]=t),this.broadcast&&!n&&this.broadcast.postMessage({type:e,data:t})}get(e){if(this.sourceObj&&e)return this.sourceObj[e];if(!e)return this.keys.reduce((t,n)=>y(c({},t),{[n]:this.sourceObj[n]}),{})}watch(e){return new Promise(t=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,()=>{this.sourceObj[e]&&t(this.sourceObj[e])}]})}watchFor(e,t){return new Promise(n=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,()=>{this.sourceObj[e]===t&&n(this.sourceObj[e])}]})}},m=(s,e,t,n)=>{let r=new f;return r.init(s,{provider:e,methods:t,broadcastName:n}),r};var j=s=>new h(m,s);
