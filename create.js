var l=Object.defineProperty,v=Object.defineProperties,M=Object.getOwnPropertyDescriptor,R=Object.getOwnPropertyDescriptors,P=Object.getOwnPropertyNames,w=Object.getOwnPropertySymbols;var m=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var k=(i,e,t)=>e in i?l(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,T=(i,e)=>{for(var t in e||(e={}))m.call(e,t)&&k(i,t,e[t]);if(w)for(var t of w(e))I.call(e,t)&&k(i,t,e[t]);return i},c=(i,e)=>v(i,R(e));var C=(i,e)=>{for(var t in e)l(i,t,{get:e[t],enumerable:!0})},x=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of P(e))!m.call(i,n)&&n!==t&&l(i,n,{get:()=>e[n],enumerable:!(r=M(e,n))||r.enumerable});return i};var j=i=>x(l({},"__esModule",{value:!0}),i);var U={};C(U,{createRepository:()=>S});module.exports=j(U);var a="__PROVIDER_ID__",u=class extends Function{constructor(){super();let e;return e=(...t)=>e.__call(...t),Object.setPrototypeOf(e,new.target.prototype)}},_=class extends u{constructor(t,r,n,o){super();this.__call=t;this.__methods=n;this.__onUpdate=[];this.__listeners={};this.call=void 0;for(let s in r)this[s]=r[s];this.muppet=new Proxy({},{get:o.bind(this)})}},b=(i,e,t)=>{function r(n,o){return n[a]&&typeof n[a]=="string"&&o!==n[a]&&(n[n[a]]?n[n[a]]=c(T({},n[n[a]]),{[o]:this[o]!==void 0?this[o]:void 0}):n[n[a]]={[o]:this[o]!==void 0?this[o]:void 0}),n[o]?n[o]:this[o]}return new Proxy(new _(e,i,t,r),{set(n,o,s){if(n[o]=s,n.__listeners[o]&&n.__listeners[o].size)for(let[p,y]of n.__listeners[o])n.muppet[p]&&(n.muppet[p]=c(T({},n.muppet[p]),{[o]:s})),y();return Array.isArray(n.__onUpdate)&&o!=="onUpdate"&&(n.__onUpdate.forEach(p=>p()),n.__onUpdate=[]),!0}})};var h=class extends u{constructor(t,r){super();this._watcherFactory=t;this._provider=r;this.keys=[];this.provider=r,this.actions=this.initRepository()}__call(t,r,n){let o,s,p=null;return r&&(s=(r.constructor.name==="Object"?Object.keys(r):Object.getOwnPropertyNames(Object.getPrototypeOf(r))).reduce((g,d)=>d!=="constructor"&&typeof r[d]=="function"?c(T({},g),{[d]:r[d].bind(r)}):g,{})),r?r.repo?(r.repo.initializeState(t),r.repo.initializeState(t,s)):(r.repo=this,r.repo.initializeState(t),r.repo.initializeState(t,s)):p=this.initRepository(t,s),n&&(o=new BroadcastChannel(`repository-${n}`),o.onmessage=({data:y})=>{y==="needSome"?o.postMessage({data:this.convertToObject()}):y.type===void 0?this.initRepository(y.data):(p||r.repo.actions).set(y.type,y.data)},o.postMessage("needSome")),(p||r.repo.actions).sourceObj}initializeState(t,r){this.actions=this.initRepository(t,r)}initRepository(t,r){this.keys=Object.keys(t||{});let n=this.keys.reduce((o,s)=>{let p;return this.actions!==void 0&&this.actions.get(s)!==void 0?p=this.actions.get(s):p=t[s],c(T({},o),{[s]:p})},t||{});return this._watcherFactory(n,this.provider,r)}convertToObject(){return this.keys.reduce((t,r)=>c(T({},t),{[r]:this.actions.get(r)}),{})}};var f=class{constructor(){this.SPECIAL_KEY=a}init(e,t,r){typeof e=="object"&&(this.sourceObj=b(e,t,r))}set(e,t){this.sourceObj&&e!=="name"&&e!=="length"&&(this.sourceObj[e]=t)}get(e){if(this.sourceObj&&e)return this.sourceObj[e]}watch(e){return new Promise(t=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,()=>{this.sourceObj[e]&&t(this.sourceObj[e])}]})}watchFor(e,t){return new Promise(r=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,()=>{this.sourceObj[e]===t&&r(this.sourceObj[e])}]})}},O=(i,e,t)=>{let r=new f;return r.init(i,e,t),r};var S=i=>new h(O,i);
