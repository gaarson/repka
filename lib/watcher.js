var o=Object.defineProperty,m=Object.defineProperties,k=Object.getOwnPropertyDescriptor,w=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertyNames,y=Object.getOwnPropertySymbols;var f=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var h=(n,e,t)=>e in n?o(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,g=(n,e)=>{for(var t in e||(e={}))f.call(e,t)&&h(n,t,e[t]);if(y)for(var t of y(e))v.call(e,t)&&h(n,t,e[t]);return n},M=(n,e)=>m(n,w(e));var I=(n,e)=>{for(var t in e)o(n,t,{get:e[t],enumerable:!0})},x=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of O(e))!f.call(n,a)&&a!==t&&o(n,a,{get:()=>e[a],enumerable:!(i=k(e,a))||i.enumerable});return n};var C=n=>x(o({},"__esModule",{value:!0}),n);var S={};I(S,{Watcher:()=>T,watcherCreator:()=>P});module.exports=C(S);var p="__PROVIDER_ID__",d=class extends Function{constructor(){super();let e;return e=(...t)=>e.__call(...t),Object.setPrototypeOf(e,new.target.prototype)}},_=class extends d{constructor(t,i,a,r){super();this.__call=t;this.__methods=a;this.__onUpdate=[];this.__listeners={};this.__criticalFields={};this.call=void 0,this.muppet=new Proxy({__init__:i},{get:r.bind(this)});for(let s in i)this.__listeners[s]=new Map,this[s]=i[s]}},b=(n,e,t)=>{function i(r,s){return r[p]&&typeof r[p]=="string"&&s!==r[p]&&s!=="__init__"&&(r[r[p]]=!1,this.__criticalFields[r[p]]=[...this.__criticalFields[r[p]]||[],s]),s==="__init__"?r.__init__:r[s]===void 0?r.__init__[s]:r[s]}function a(r,s,l){return r[s]=l,r.muppet.__init__=M(g({},r.muppet.__init__),{[s]:l}),r.__listeners[s]&&r.__listeners[s].size&&r.__listeners[s].forEach((c,u)=>{r.muppet[u]!==void 0&&r.muppet[u]===!1&&(r.muppet[u]=!0),c()}),Array.isArray(r.__onUpdate)&&s!=="__onUpdate"&&(r.__onUpdate.forEach(c=>c()),r.__onUpdate=[]),!0}return new Proxy(new _(e,n,t,i),{set:a})};var T=class{constructor(){this.keys=[];this.SPECIAL_KEY=p}init(e,t={}){typeof e=="object"&&!Array.isArray(e)&&(this.keys=Object.keys(e||{}),this.sourceObj=b(e,t.provider,t.methods)),t.broadcastName&&this.createBroadcast(t.broadcastName)}createBroadcast(e="broadcastWatcher"){this.broadcast=new BroadcastChannel(e),this.broadcast.onmessage=({data:t})=>{if(t==="needSome")this.broadcast.postMessage({data:this.get()});else if(t.type===void 0)for(let i in t.data)this.sourceObj[i]=t.data[i];else this.set(t.type,t.data,!0)},this.broadcast.postMessage("needSome")}set(e,t,i=!1){this.sourceObj&&(this.sourceObj[e]=t),this.broadcast&&!i&&this.broadcast.postMessage({type:e,data:t})}get(e){if(this.sourceObj&&e)return this.sourceObj.muppet[e];if(!e)return this.sourceObj.muppet.__init__}watch(e){return new Promise(t=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,()=>{this.sourceObj[e]&&t(this.sourceObj[e])}]})}watchFor(e,t){return new Promise(i=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,()=>{this.sourceObj[e]===t&&i(this.sourceObj[e])}]})}},P=(n,e,t,i)=>{let a=new T;return a.init(n,{provider:e,methods:t,broadcastName:i}),a};
