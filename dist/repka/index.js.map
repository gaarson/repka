{
  "version": 3,
  "sources": ["../../packages/reaction/reaction.ts", "../../packages/react-provider/hookAndHok.ts", "../../packages/repka/index.ts"],
  "sourcesContent": ["import { FIELDS_PREFIX } from \"core/domain\";\nimport { REACTION_STACK } from \"reaction\";\n\ntype Store = {\n  [`__REPO__onUpdate`]?: ((prop: string, value: unknown, obj: any) => void)[];\n};\n\nexport class Reaction {\n  private name: string;\n  private scheduler: () => void;\n  private dependencies = new Map<Store, Set<string>>();\n  private isDisposed = false;\n\n  constructor(name: string, scheduler: () => void) {\n    this.name = name;\n    this.scheduler = scheduler;\n  }\n\n  track<T>(fn: () => T): T {\n    if (this.isDisposed) return fn();\n\n    for (const props of this.dependencies.values()) {\n      props.clear();\n    }\n\n    REACTION_STACK.push(this);\n    try {\n      return fn();\n    } finally {\n      REACTION_STACK.pop();\n    }\n  }\n\n  reportDependency(store: Store, prop: string) {\n    if (this.isDisposed) return;\n\n    let deps = this.dependencies.get(store);\n    if (!deps) {\n      deps = new Set();\n      this.dependencies.set(store, deps);\n\n      if (store[`${FIELDS_PREFIX}onUpdate`].indexOf(this.onUpdate) === -1) {\n        store[`${FIELDS_PREFIX}onUpdate`].push(this.onUpdate);\n      }\n    }\n    deps.add(prop);\n  }\n\n  private onUpdate = (updatedProp: string, value: unknown, store: Store) => {\n    const props = this.dependencies.get(store);\n    if (props && props.has(updatedProp)) {\n      this.scheduler();\n    }\n  }\n\n  updateScheduler(scheduler: () => void) {\n\u00A0 \u00A0 this.scheduler = scheduler;\n\u00A0 }\n  undispose() {\n\u00A0 \u00A0 this.isDisposed = false;\n\u00A0 }\n\n  dispose() {\n    if (this.isDisposed) return;\n\n    for (const store of this.dependencies.keys()) {\n      const index = store[`${FIELDS_PREFIX}onUpdate`].indexOf(this.onUpdate);\n      if (index > -1) {\n        store[`${FIELDS_PREFIX}onUpdate`].splice(index, 1);\n      }\n    }\n    this.dependencies.clear();\n    this.isDisposed = true;\n  }\n}\n\n", "import React, { useReducer, useRef, useEffect } from 'react';\n\nimport { Reaction } from 'reaction/reaction';\nimport { simpleHook } from './index';\n\nfunction createHOCWrapper<P extends {}>(\n  store: any, \n  Component: React.ComponentType\n): React.FC<P> {\n  const HOCWrapper: React.FC<P> = (props: P) => {\n\u00A0 \u00A0 const [, forceUpdate] = useReducer(x => x + 1, 0);\n\n\u00A0 \u00A0 const reactionRef = useRef<Reaction | null>(null);\n\n\u00A0 \u00A0 if (reactionRef.current === null) {\n      const componentName = Component.displayName || Component.name || 'Component';\n\u00A0 \u00A0 \u00A0 reactionRef.current = new Reaction(`${componentName}_Observer`, forceUpdate);\n\u00A0 \u00A0 }\n\n    reactionRef.current.updateScheduler(forceUpdate);\n\n\u00A0 \u00A0 useEffect(() => {\n\u00A0 \u00A0 \u00A0 reactionRef.current.undispose();\n\u00A0 \u00A0 \u00A0 return () => reactionRef.current.dispose();\n\u00A0 \u00A0 }, [reactionRef.current]);\n\n\u00A0 \u00A0 return reactionRef.current.track(() => {\n\u00A0 \u00A0 \u00A0 return Component(props);\n\u00A0 \u00A0 });\n\u00A0 };\n\n  HOCWrapper.displayName = `RepkaObserver(${Component.displayName || Component.name})`;\n  return HOCWrapper;\n}\n\nexport function repkaHookAndHoc<T extends object>(\n  this: T,\n  arg: React.ComponentType<any> | keyof T\n): React.FC<any> | T[keyof T] {\n  try {\n    if (typeof arg !== 'string') return createHOCWrapper<T>(this, arg as React.ComponentType<any>); \n    else if (arg) return simpleHook<T>(this, arg as keyof T);\n    else console.error(\n      '[Repka] \u041E\u0448\u0438\u0431\u043A\u0430 \u0432\u044B\u0437\u043E\u0432\u0430 \u0445\u0443\u043A\u0430. \u041D\u0443\u0436\u043D\u043E \u0443\u043A\u0430\u0437\u0430\u0442\u044C \u043B\u0438\u0431\u043E \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043E\u043C\u043F\u043E\u043D\u0435\u043D\u0442 \u043B\u0438\u0431\u043E \u0438\u043C\u044F \u043F\u043E\u043B\u044F \u0437\u0430 \u043A\u043E\u0442\u043E\u0440\u044B\u043C \u0445\u043E\u0442\u0438\u0442\u0435 \u0441\u043B\u0435\u0434\u0438\u0442\u044C'\n    );\n  } catch (e) {\n    console.error('[Repka] \u041E\u0448\u0438\u0431\u043A\u0430 \u0432\u044B\u0437\u043E\u0432\u0430 \u0445\u0443\u043A\u0430. \u0423\u0431\u0435\u0434\u0438\u0442\u0435\u0441\u044C, \u0447\u0442\u043E state() \u0432\u044B\u0437\u044B\u0432\u0430\u0435\u0442\u0441\u044F \u043D\u0430 \u0432\u0435\u0440\u0445\u043D\u0435\u043C \u0443\u0440\u043E\u0432\u043D\u0435 \u043A\u043E\u043C\u043F\u043E\u043D\u0435\u043D\u0442\u0430.', e);\n    return this;\n  }\n}\n", "import { createSource } from 'core';\nimport { simpleReactProvider } from 'react-provider';\nimport { repkaHookAndHoc } from 'react-provider/hookAndHok';\nimport React from 'react';\n\ninterface IRepkaCallable<T> {\n  <P extends {}>(Component: React.ComponentType<P>): React.FC<P>;\n  <K extends keyof T>(prop: K): T[K];\n}\n\nexport type RepkaStore<T> = T & IRepkaCallable<T>;\n\nexport const repka = <T extends object>(obj: T): RepkaStore<T> => {\n  const store = createSource<\n    T,\n    { main: typeof repkaHookAndHoc; getter: typeof simpleReactProvider }\n  >(obj, { main: repkaHookAndHoc, getter: simpleReactProvider });\n\n  return store as unknown as RepkaStore<T>;\n};\n\nexport { watch } from 'watcher';\n"],
  "mappings": "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",
  "names": []
}
