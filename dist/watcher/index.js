var c=class extends Function{constructor(){super();let e;return e=(...s)=>e.__call(...s),Object.setPrototypeOf(e,new.target.prototype)}},i="__PROVIDER_ID__",t="__REPO__",b=(r,e)=>(r[`${t}muppet`][i]&&e!==r[`${t}muppet`][i]&&typeof e=="string"&&!e.startsWith(t)&&(r[`${t}muppet`][r[`${t}muppet`][i]]=!1,r[`${t}criticalFields`][r[`${t}muppet`][i]]=[...new Set([...r[`${t}criticalFields`][r[`${t}muppet`][i]]||[],e])]),typeof e=="string"&&e.startsWith(t)||e==="__call"?r[e]:r[`${t}data`][e]),O=(r,e,s)=>typeof e=="string"&&e.startsWith(t)||e==="__call"?(r[e]=s,!0):(r[`${t}data`]={...r[`${t}data`],[e]:s},r[`${t}listeners`][e]&&r[`${t}listeners`][e].size&&r[`${t}listeners`][e].forEach((a,o)=>{r[`${t}muppet`][o]!==void 0&&r[`${t}muppet`][o]===!1&&(r[`${t}muppet`][o]=!0),a()}),r[`${t}onUpdate`].length&&r[`${t}onUpdate`].forEach(a=>a&&a(e)),!0),T=(r,e,s)=>{try{let a=function(){return e?[this,e]:this},o=new c;e&&(o[`${t}methods`]=e),o[`${t}onUpdate`]=[],o[`${t}data`]=r,o[`${t}criticalFields`]={},o[`${t}muppet`]={},o[`${t}listeners`]=Object.keys(r).reduce((d,u)=>({...d,[u]:new Map}),{});let n=new Proxy(o,{set:O,get:b});return o.__call=(s||a).bind(n),n}catch(a){console.error("SOURCE OBJECT ERROR: ",a)}};var p=class{constructor(){this.SPECIAL_KEY=i}init(e,s={}){typeof e=="object"&&!Array.isArray(e)&&(s.provider&&(this.savedProvider=s.provider),this.sourceObj=T(e,s.methods,s.provider||this.savedProvider)),s.broadcastName&&this.createBroadcast(s.broadcastName)}createBroadcast(e="broadcastWatcher"){this.broadcast=new BroadcastChannel(e),this.broadcast.onmessage=({data:s})=>{if(s==="needSome")this.broadcast.postMessage({data:this.get()});else if(s.type===void 0)for(let a in s.data)this.sourceObj[a]=s.data[a]},this.broadcast.postMessage("needSome")}set(e,s,a=!1){this.sourceObj&&(this.sourceObj[e]=s),this.broadcast&&!a&&this.broadcast.postMessage({type:e,data:s})}get(e){if(this.sourceObj&&e)return this.sourceObj[e];if(!e)return this.sourceObj[`${t}data`]}watch(e){let s=this.sourceObj[`${t}onUpdate`].length;return new Promise(a=>{this.sourceObj[`${t}onUpdate`]=[...this.sourceObj[`${t}onUpdate`],o=>{e===o&&(a(this.sourceObj[e]),this.sourceObj[`${t}onUpdate`][s]=null,this.sourceObj[`${t}onUpdate`].every(n=>n===null)&&(this.sourceObj[`${t}onUpdate`]=[]))}]})}watchFor(e,s){let a=this.sourceObj[`${t}onUpdate`].length;return new Promise(o=>{this.sourceObj[`${t}onUpdate`]=[...this.sourceObj[`${t}onUpdate`],n=>{e===n&&this.sourceObj[e]===s&&(o(this.sourceObj[e]),this.sourceObj[`${t}onUpdate`][a]=null,this.sourceObj[`${t}onUpdate`].every(d=>d===null)&&(this.sourceObj[`${t}onUpdate`]=[]))}]})}},w=(r,e,s,a)=>{let o=new p;return o.init(r,{provider:e,methods:s,broadcastName:a}),o};export{p as Watcher,w as watcherCreator};
