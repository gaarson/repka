var u=Object.defineProperty,m=Object.defineProperties,k=Object.getOwnPropertyDescriptor,w=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertyNames,y=Object.getOwnPropertySymbols;var f=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var h=(n,e,t)=>e in n?u(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,g=(n,e)=>{for(var t in e||(e={}))f.call(e,t)&&h(n,t,e[t]);if(y)for(var t of y(e))v.call(e,t)&&h(n,t,e[t]);return n},b=(n,e)=>m(n,w(e));var I=(n,e)=>{for(var t in e)u(n,t,{get:e[t],enumerable:!0})},x=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of O(e))!f.call(n,a)&&a!==t&&u(n,a,{get:()=>e[a],enumerable:!(i=k(e,a))||i.enumerable});return n};var j=n=>x(u({},"__esModule",{value:!0}),n);var U={};I(U,{Watcher:()=>c,watcherCreator:()=>C});module.exports=j(U);var o="__PROVIDER_ID__",d=class extends Function{constructor(){super();let e;return e=(...t)=>e.__call(...t),Object.setPrototypeOf(e,new.target.prototype)}},T=class extends d{constructor(t,i,a,r){super();this.__call=t;this.__methods=a;this.__onUpdate=[];this.__listeners={};this.__criticalFields={};this.call=void 0,this.muppet=new Proxy({__init__:i},{get:r.bind(this)});for(let s in i)this.__listeners[s]=new Map,this[s]=i[s]}},M=(n,e,t)=>{function i(r,s){return r[o]&&typeof r[o]=="string"&&s!==r[o]&&s!=="__init__"&&(r[r[o]]=!1,this.__criticalFields[r[o]]=[...this.__criticalFields[r[o]]||[],s]),s==="__init__"?r.__init__:r[s]===void 0?r.__init__[s]:r[s]}function a(r,s,l){return r[s]=l,r.muppet.__init__=b(g({},r.muppet.__init__),{[s]:l}),r.__listeners[s]&&r.__listeners[s].size&&r.__listeners[s].forEach((p,_)=>{r.muppet[_]!==void 0&&r.muppet[_]===!1&&(r.muppet[_]=!0),p()}),Array.isArray(r.__onUpdate)&&s!=="__onUpdate"&&r.__onUpdate.forEach(p=>p&&p(s)),!0}return new Proxy(new T(e,n,t,i),{set:a})};var c=class{constructor(){this.keys=[];this.SPECIAL_KEY=o}init(e,t={}){typeof e=="object"&&!Array.isArray(e)&&(this.keys=Object.keys(e||{}),this.sourceObj=M(e,t.provider,t.methods)),t.broadcastName&&this.createBroadcast(t.broadcastName)}createBroadcast(e="broadcastWatcher"){this.broadcast=new BroadcastChannel(e),this.broadcast.onmessage=({data:t})=>{if(t==="needSome")this.broadcast.postMessage({data:this.get()});else if(t.type===void 0)for(let i in t.data)this.sourceObj[i]=t.data[i];else this.set(t.type,t.data,!0)},this.broadcast.postMessage("needSome")}set(e,t,i=!1){this.sourceObj&&(this.sourceObj[e]=t),this.broadcast&&!i&&this.broadcast.postMessage({type:e,data:t})}get(e){if(this.sourceObj&&e)return this.sourceObj.muppet[e];if(!e)return this.sourceObj.muppet.__init__}watch(e){let t=this.sourceObj.__onUpdate.length;return new Promise(i=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,a=>{e===a&&(i(this.sourceObj[e]),this.sourceObj.__onUpdate[t]=null,this.sourceObj.__onUpdate.every(r=>r===null)&&(this.sourceObj.__onUpdate=[]))}]})}watchFor(e,t){let i=this.sourceObj.__onUpdate.length;return new Promise(a=>{this.sourceObj.__onUpdate=[...this.sourceObj.__onUpdate,r=>{e===r&&this.sourceObj[e]===t&&(a(this.sourceObj[e]),this.sourceObj.__onUpdate[i]=null,this.sourceObj.__onUpdate.every(s=>s===null)&&(this.sourceObj.__onUpdate=[]))}]})}},C=(n,e,t,i)=>{let a=new c;return a.init(n,{provider:e,methods:t,broadcastName:i}),a};
